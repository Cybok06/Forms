<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>{{ form.title }}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link rel="icon" href="https://store-images.s-microsoft.com/image/apps.44537.13628881801009959.f429098c-f6ba-4196-a164-1109adc458e8.5f1e249b-7942-4e1d-aa67-487271e222e5" type="image/x-icon">
{% if suspended %}
<meta name="robots" content="noindex,nofollow">
{% endif %}

<style>
  /* ================= Design Tokens (with theme fallbacks) ================= */
  :root{
    --ink:   {{ (form.theme.ink   if form.theme and form.theme.ink   else "#0b1320") }};
    --muted: {{ (form.theme.muted if form.theme and form.theme.muted else "#64748b") }};
    --ring:  {{ (form.theme.ring  if form.theme and form.theme.ring  else "#e5e7eb") }};
    --soft:  {{ (form.theme.soft  if form.theme and form.theme.soft  else "#f6f8fb") }};
    --brand: {{ (form.theme.brand if form.theme and form.theme.brand else "#0ea5e9") }};
    --ok:    {{ (form.theme.ok    if form.theme and form.theme.ok    else "#16a34a") }};

    --card-bg: #fff;
    --radius-card: 18px;
    --shadow: 0 12px 36px rgba(2,6,23,.08);
    --focus: 0 0 0 2px rgba(14,165,233,.28), 0 0 0 4px rgba(14,165,233,.18);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --ink:   {{ (form.theme.ink   if form.theme and form.theme.ink   else "#e6e7e9") }};
      --muted: {{ (form.theme.muted if form.theme and form.theme.muted else "#9aa3af") }};
      --ring:  {{ (form.theme.ring  if form.theme and form.theme.ring  else "#2a2f36") }};
      --soft:  {{ (form.theme.soft  if form.theme and form.theme.soft  else "#0e1116") }};
      --card-bg: #0f1319;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
    }
  }

  /* ================= Page & Header ================= */
  body{ background:var(--soft); color:var(--ink); }
  .page{ max-width:960px; margin:40px auto; padding: 0 16px; }

  .hero-img{
    max-height: 220px; object-fit: cover; border-radius: 14px;
    border: 1px solid var(--ring);
  }

  .title-wrap{
    margin-top: 18px;
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }
  .title{
    margin:0; font-weight:700; letter-spacing:.2px; line-height:1.2;
    font-size: clamp(22px, 3.5vw, 28px);
  }
  .desc{ color:var(--muted); margin-top:6px; }

  .accent{
    height:4px; width:100%; border-radius:10px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
    margin: 14px 0 0;
    mask: linear-gradient(90deg, rgba(0,0,0,.0), rgba(0,0,0,1) 8%, rgba(0,0,0,1) 92%, rgba(0,0,0,.0));
    -webkit-mask: linear-gradient(90deg, rgba(0,0,0,.0), rgba(0,0,0,1) 8%, rgba(0,0,0,1) 92%, rgba(0,0,0,.0));
  }

  /* ================= Card ================= */
  .cardx{
    background:var(--card-bg); border:1px solid var(--ring); border-radius:var(--radius-card); padding:24px;
    box-shadow: var(--shadow);
    transform: translateY(10px); opacity:0; animation: cardIn 420ms cubic-bezier(.2,.65,.3,1) forwards 80ms;
  }
  @keyframes cardIn { to{ transform: translateY(0); opacity:1; } }

  /* ================= Fields ================= */
  .req::after{ content:" *"; color:#dc2626; }
  .form-label{ font-weight:600; }
  .form-text{ color:var(--muted) !important; }
  .form-control, .form-select{ border:1px solid var(--ring); transition: border-color .15s, box-shadow .15s; }
  .form-control:focus, .form-select:focus{
    border-color: var(--brand); box-shadow: var(--focus);
  }

  /* Turn green when filled & valid */
  .filled-ok{
    border-color: var(--ok) !important;
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--ok) 60%, transparent);
  }

  .input-wrap{ position: relative; }
  .input-wrap .leading{
    position:absolute; left:12px; top:50%; transform:translateY(-50%);
    pointer-events:none; color:var(--muted);
  }
  .input-wrap input[type="text"],
  .input-wrap input[type="email"],
  .input-wrap input[type="tel"],
  .input-wrap input[type="number"],
  .input-wrap input[type="date"]{
    padding-left: 40px;
  }

  .err-note{ display:none; color:#b91c1c; font-size:.875rem; margin-top:.25rem; }
  .is-invalid + .err-note{ display:block; }

  .btn-primary{
    background: linear-gradient(90deg, var(--brand), var(--ok)); border: none;
    box-shadow: 0 6px 18px rgba(14,165,233,.25);
  }
  .btn-primary:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(14,165,233,.30); }
  .btn-primary:active{ transform: translateY(0); box-shadow:0 6px 18px rgba(14,165,233,.22); }
  .btn[disabled]{ opacity:.65; cursor:not-allowed; }

  /* Overlay */
  .overlay{ position: fixed; inset: 0; background: rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index: 9999; backdrop-filter: blur(2px); }
  .overlay.show{ display:flex; }
  .overlay-card{ background: var(--card-bg); color: var(--ink); border:1px solid var(--ring); border-radius: 14px; padding: 18px 20px; min-width: 240px; box-shadow: var(--shadow); text-align:center; }
  .spinner{ width: 36px; height: 36px; border-radius: 50%; border: 3px solid var(--ring); border-top-color: var(--brand); margin: 0 auto 10px; animation: spin 900ms linear infinite; }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  /* =============== Suspended view additions =============== */
  .s-banner{
    border:1px dashed var(--ring);
    border-radius:14px;
    padding:16px;
    background:linear-gradient(180deg, rgba(14,165,233,.08), transparent 70%), var(--card-bg);
  }
  .s-icon{
    width:44px; height:44px; border-radius:10px;
    display:inline-flex; align-items:center; justify-content:center;
    background: #fff; border:1px solid var(--ring);
  }
  .s-chip{
    display:inline-block; padding:.25rem .5rem; border-radius:999px;
    border:1px solid var(--ring); background:#fff; font-size:.8rem; color:#7a271a;
  }
  .s-actions .btn{ min-width: 140px; }
  .muted{ color: var(--muted); }
  .link-muted{ color: var(--muted); text-decoration: none; }
  .link-muted:hover{ text-decoration: underline; }
  @media (max-width: 480px){
    .s-actions .btn{ width:100%; }
  }

  @media (prefers-reduced-motion: reduce){
    .cardx{ animation:none !important; }
  }
</style>
</head>
<body>
<div class="page container">

  {% if form.form_image_id and not suspended %}
    <img class="img-fluid hero-img" src="{{ url_for('form_bp.get_file', file_id=form.form_image_id) }}" alt="Form header image">
  {% endif %}

  <div class="title-wrap">
    <div>
      <h1 class="title">{{ form.title }}</h1>
      {% if form.description and not suspended %}
        <p class="desc">{{ form.description }}</p>
      {% endif %}
    </div>
  </div>
  <div class="accent" aria-hidden="true"></div>

  {% if suspended %}
    <!-- ===== Suspended / Unavailable UI ===== -->
    <div class="cardx mt-3">
      <div class="s-banner mb-3 d-flex align-items-center gap-3 flex-wrap">
        <span class="s-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="6" y="4" width="4" height="16" rx="1.5"></rect>
            <rect x="14" y="4" width="4" height="16" rx="1.5"></rect>
          </svg>
        </span>
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="h5 m-0">This form is currently unavailable</span>
            <span class="s-chip">Suspended</span>
          </div>
          <div class="muted mt-1">The owner has temporarily disabled responses to this form.</div>
        </div>
      </div>

      {% if form.description %}
        <p class="muted mb-4">{{ form.description }}</p>
      {% endif %}

      <div class="s-actions d-flex gap-2 flex-wrap">
        <a class="btn btn-outline-secondary" href="/" role="button">
          <i class="bi bi-house-door me-1"></i> Go Home
        </a>
        <a class="btn btn-primary" href="mailto:{{ (form.owner_email or '') }}" role="button">
          <i class="bi bi-envelope me-1"></i> Contact Owner
        </a>
      </div>

      <hr class="my-4">

      <div class="small muted">
        If you’re the owner, <a class="link-muted" href="{{ url_for('admin_bp.view_form', slug=form.slug) }}">sign in to re-activate this form</a>.
      </div>
    </div>
  {% else %}
    <!-- ===== Normal Form UI ===== -->
    <form class="cardx mt-3" method="post" action="{{ url_for('form_bp.submit_form', slug=form.slug) }}" enctype="application/x-www-form-urlencoded" novalidate>
      <div class="vstack gap-3">

        {% for f in form.fields %}
          {% set req = 'required' if f.required else '' %}
          {% set reqclass = 'req' if f.required else '' %}
          {% set ac = 'name' if 'name' in (f.id|string) else ('email' if f.type=='email' else ('tel' if f.type=='tel' else 'on')) %}
          {% set inputmode = 'numeric' if f.type=='number' else ('tel' if f.type=='tel' else ('email' if f.type=='email' else 'text')) %}

          {# ===== SELECT (Dropdown) ===== #}
          {% if f.type == 'select' %}
            <div>
              <label class="form-label {{ reqclass }}" for="{{ f.id }}">{{ f.label }}</label>
              <select
                class="form-select"
                id="{{ f.id }}"
                name="{{ f.id }}"
                {{ req }}
                autocomplete="on"
              >
                <option value=""></option>
                {% for opt in f.options %}
                  <option value="{{ opt }}" {% if f.default and f.default == opt %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
              <div class="err-note">Please choose an option.</div>
            </div>

          {# ===== INPUTS (text/email/tel/date/number) ===== #}
          {% elif f.type in ['text','email','tel','date','number'] %}
            <div>
              <label class="form-label {{ reqclass }}" for="{{ f.id }}">{{ f.label }}</label>
              <div class="input-wrap">
                <span class="leading">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="3"/><path d="M7 8h10M7 12h6M7 16h8" stroke-linecap="round"/></svg>
                </span>
                <input
                  class="form-control"
                  type="{{ f.type }}"
                  id="{{ f.id }}"
                  name="{{ f.id }}"
                  placeholder="{{ f.placeholder or '' }}"
                  {% if f.pattern %}pattern="{{ f.pattern }}"{% endif %}
                  autocomplete="{{ ac }}"
                  inputmode="{{ inputmode }}"
                  {{ req }}
                >
              </div>
              {% if f.format %}<div class="form-text">Format: {{ f.format }}</div>{% endif %}
              <div class="err-note">Please enter a valid value.</div>
            </div>

          {# ===== TEXTAREA ===== #}
          {% elif f.type == 'textarea' %}
            <div>
              <label class="form-label {{ reqclass }}" for="{{ f.id }}">{{ f.label }}</label>
              <textarea class="form-control" id="{{ f.id }}" name="{{ f.id }}" rows="4" placeholder="{{ f.placeholder or '' }}" {{ req }}></textarea>
              <div class="err-note">This field is required.</div>
            </div>

          {# ===== Fallback (shouldn't hit) ===== #}
          {% else %}
            <div>
              <label class="form-label {{ reqclass }}" for="{{ f.id }}">{{ f.label }}</label>
              <input class="form-control" type="text" id="{{ f.id }}" name="{{ f.id }}" placeholder="{{ f.placeholder or '' }}" {{ req }}>
              <div class="err-note">Please enter a valid value.</div>
            </div>
          {% endif %}
        {% endfor %}

        <div class="d-flex gap-2 flex-wrap">
          <button id="submitBtn" class="btn btn-primary" type="submit">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" style="margin-right:8px;">
              <path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z" stroke-linejoin="round"/>
            </svg>
            Submit
          </button>
          <button id="resetBtn" class="btn btn-outline-secondary" type="reset">Reset</button>
        </div>
      </div>
    </form>
  {% endif %}
</div>

<!-- Full-screen loading overlay (used in active mode only) -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="overlay-card" role="status" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div>Submitting…</div>
  </div>
</div>

{% if not suspended %}
<script>
  // ==== Draft autosave + validation + green-when-filled (only when active) ====
  (function(){
    const form = document.querySelector('form');
    if(!form) return;
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const overlay   = document.getElementById('overlay');

    const STORAGE_KEY = `formdraft:{{ form.slug }}`;

    /* ---------- Draft Save / Load ---------- */
    let saveTimer = null;
    function scheduleSave(){
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(saveDraft, 250);
    }

    function collectValues(){
      const data = {};
      form.querySelectorAll('input, textarea, select').forEach(el=>{
        const key = el.name || el.id;
        if(!key) return;
        if(el.type === 'checkbox') data[key] = !!el.checked;
        else data[key] = el.value;
      });
      return data;
    }

    function applyValues(data){
      if(!data || typeof data !== 'object') return;
      form.querySelectorAll('input, textarea, select').forEach(el=>{
        const key = el.name || el.id;
        if(!key || !(key in data)) return;
        if(el.type === 'checkbox') el.checked = !!data[key];
        else el.value = data[key];
      });
    }

    function saveDraft(){
      try{
        const payload = { t: Date.now(), v: collectValues() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }catch(e){}
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(parsed && parsed.v) applyValues(parsed.v);
      }catch(e){}
    }
    function clearDraft(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} }

    loadDraft();

    /* ---------- Validation helpers ---------- */
    function setInvalid(input, invalid){
      if(invalid) input.classList.add('is-invalid');
      else input.classList.remove('is-invalid');
    }

    // Turn green only when non-empty AND passes browser validity (type, pattern, required)
    function updateFilledState(el){
      const hasValue = (el.tagName === 'SELECT') ? (el.value !== '') : (el.value.trim() !== '');
      const isValid = el.checkValidity(); // built-in validation (required, type, pattern)
      if(hasValue && isValid){
        el.classList.add('filled-ok');
        setInvalid(el, false);
      }else{
        el.classList.remove('filled-ok');
        // only show error if user tried to submit (handled in submit) or field explicitly invalid
      }
    }

    // Quick validate all fields; uses built-in validity first, then pattern fallback if needed
    function quickValidate(){
      let bad = false;
      form.querySelectorAll('input, textarea, select').forEach(el=>{
        // built-in validity handles required/type/pattern
        const valid = el.checkValidity();
        if(!valid){
          setInvalid(el, true);
          bad = true;
        }else{
          setInvalid(el, false);
        }
        updateFilledState(el);
      });
      return !bad;
    }

    // Bind listeners
    form.addEventListener('input', (e)=>{
      const el = e.target;
      if(!(el instanceof HTMLElement)) return;
      if(!['INPUT','TEXTAREA','SELECT'].includes(el.tagName)) return;
      updateFilledState(el);
      scheduleSave();
    }, true);

    form.addEventListener('change', (e)=>{
      const el = e.target;
      if(!(el instanceof HTMLElement)) return;
      if(!['INPUT','TEXTAREA','SELECT'].includes(el.tagName)) return;
      updateFilledState(el);
      scheduleSave();
    }, true);

    // After loading draft, mark initial states
    requestAnimationFrame(()=>{
      form.querySelectorAll('input, textarea, select').forEach(updateFilledState);
    });

    // Reset clears draft + visuals
    resetBtn?.addEventListener('click', ()=>{
      setTimeout(()=>{
        clearDraft();
        form.querySelectorAll('.is-invalid,.filled-ok').forEach(el=>{
          el.classList.remove('is-invalid','filled-ok');
        });
      }, 0);
    });

    /* ---------- Submit flow ---------- */
    function showOverlay(){ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); }
    function hideOverlay(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }

    let submitting = false;
    window.addEventListener('pagehide', ()=>{ if(submitting){ clearDraft(); } });

    form.addEventListener('submit', (e)=>{
      // Validate everything once more
      if(!quickValidate()){
        e.preventDefault();
        // Focus first invalid field
        const badEl = form.querySelector('.is-invalid');
        if(badEl && badEl.focus) badEl.focus();
        return;
      }
      saveDraft();
      submitBtn.setAttribute('disabled','true');
      submitBtn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Submitting…
      `;
      showOverlay();
      submitting = true;

      // Safety: hide after 10s if still on page (server should render next page quickly)
      setTimeout(()=>{ if(!document.hidden) hideOverlay(); }, 10000);
    }, false);
  })();
</script>
{% endif %}
</body>
</html>
